<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="v2.6.11">
<title>Vue</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.hidden {
  display: none;
}

.switch {
  border-width: 1px 1px 0 1px;
  border-style: solid;
  border-color: #666;
  display: inline-block;
}

.switch--item {
  text-align: center;
  min-width: 40px;
  padding: 5px;
  background-color: #ffffff;
  color: #666;
  display: inline-block;
  cursor: pointer;
}

.switch--item:not(:first-child) {
  border-width: 0 0 0 1px;
  border-style: solid;
  border-color: #666;
}

.switch--item.selected {
  background-color: #666;
  color: #ffffff;
}

</style>
<script src="https://cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
  $('.primary').each(function () {
    primary = $(this);
    createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
    primary.children('.title').remove();
    primary.siblings('div[class*="secondary"]')
      .each(function (idx, node) {
        secondary = $(node);
        switchItem = createSwitchItem(secondary, primary.children('.switch'));
        switchItem.content.addClass('hidden');
        primary.append(switchItem.content);
        secondary.remove();
      });
  });
}

function createBlockSwitch(primary) {
  blockSwitch = $('<div class="switch"></div>');
  primary.prepend(blockSwitch);
  return blockSwitch;
}

function findPrimary(secondary) {
  candidate = secondary.prev();
  while (!candidate.is('.primary')) {
    candidate = candidate.prev();
  }
  return candidate;
}

function createSwitchItem(block, blockSwitch) {
  blockName = block.children('.title').text();
  content = block.children('.content').first().append(block.next('.colist'));
  item = $('<div class="switch--item">' + blockName + '</div>');
  item.on('click', '', content, function (e) {
    $(this).addClass('selected');
    $(this).siblings().removeClass('selected');
    e.data.siblings('.content').addClass('hidden');
    e.data.removeClass('hidden');
  });
  blockSwitch.append(item);
  return {'item': item, 'content': content};
}

function globalSwitch() {
  $('.switch--item').each(function () {
    $(this).off('click');
    $(this).on('click', function () {
      selectedText = $(this).text()
      selectedIndex = $(this).index()
      $(".switch--item").filter(function () {
        return ($(this).text() === selectedText)
      }).each(function () {
        $(this).addClass('selected');
        $(this).siblings().removeClass('selected');
        selectedContent = $(this).parent().siblings(".content").eq(selectedIndex)
        selectedContent.removeClass('hidden');
        selectedContent.siblings().addClass('hidden');
      });
    });
  });
}

$(addBlockSwitches);
$(globalSwitch);

</script>

</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Vue</h1>
<div class="details">
<span id="author" class="author">v2.6.11</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#vue-prototype-init">1. Vue prototype初始化过程</a></li>
<li><a href="#vue-instance-init">2. Vue实例init</a></li>
<li><a href="#vue-patch">3. patch</a>
<ul class="sectlevel2">
<li><a href="#_patchvnode">3.1. patchVNode</a></li>
<li><a href="#_updatechildren">3.2. updateChildren</a></li>
</ul>
</li>
<li><a href="#vue-debug-env">4. 调试环境搭建</a>
<ul class="sectlevel2">
<li><a href="#_下载代码">4.1. 下载代码</a></li>
<li><a href="#_修改配置">4.2. 修改配置</a></li>
<li><a href="#_打包vue">4.3. 打包vue</a></li>
<li><a href="#_测试页面">4.4. 测试页面</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="vue-prototype-init"><a class="link" href="#vue-prototype-init">1. Vue prototype初始化过程</a></h2>
<div class="sectionbody">
<div class="olist loweralpha">
<div class="title">instance/index.js</div>
<ol class="loweralpha" type="a">
<li>
<p>定义Vue构造函数: <code>function Vue(options){this._init(options)}</code></p>
</li>
<li>
<p>设置Vue.prototype一些属性/方法:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>_init</p>
</li>
<li>
<p>$data</p>
</li>
<li>
<p>$props</p>
</li>
<li>
<p>$set</p>
</li>
<li>
<p>$delete</p>
</li>
<li>
<p>$watch</p>
</li>
<li>
<p>$on</p>
</li>
<li>
<p>$emit</p>
</li>
<li>
<p>$once</p>
</li>
<li>
<p>$off</p>
</li>
<li>
<p>_update</p>
</li>
<li>
<p>$forceUpdate</p>
</li>
<li>
<p>$destroy</p>
</li>
<li>
<p>$nextTick</p>
</li>
<li>
<p>_render</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="olist loweralpha">
<div class="title">core/index.js</div>
<ol class="loweralpha" type="a">
<li>
<p>设置config默认属性</p>
</li>
<li>
<p>设置Vue一些方法:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>set</p>
</li>
<li>
<p>delete</p>
</li>
<li>
<p>nextTick</p>
</li>
<li>
<p>observable</p>
</li>
<li>
<p>use</p>
</li>
<li>
<p>mixin</p>
</li>
<li>
<p>extend</p>
</li>
<li>
<p>component</p>
</li>
<li>
<p>directive</p>
</li>
<li>
<p>filter</p>
</li>
</ol>
</div>
</li>
<li>
<p>设置Vue一些属性:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>options</p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p>components 默认添加KeepAlive组件</p>
</li>
<li>
<p>directives</p>
</li>
<li>
<p>filters</p>
</li>
<li>
<p>_base 指向Vue</p>
</li>
</ol>
</div>
</li>
<li>
<p>FunctionalRenderContext</p>
</li>
<li>
<p>version</p>
</li>
</ol>
</div>
</li>
<li>
<p>设置Vue.prototype一些属性:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>$isServer</p>
</li>
<li>
<p>$ssrContext</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="olist loweralpha">
<div class="title">runtime/index.js</div>
<ol class="loweralpha" type="a">
<li>
<p>设置config一些属性</p>
</li>
<li>
<p>设置Vue.options.directives mode/show</p>
</li>
<li>
<p>设置Vue.options.components Transition/TransitionGroup</p>
</li>
<li>
<p>设置Vue.prototype.__patch__</p>
</li>
<li>
<p>设置Vue.prototype.$mount</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vue-instance-init"><a class="link" href="#vue-instance-init">2. Vue实例init</a></h2>
<div class="sectionbody">
<div class="olist arabic">
<div class="title">src/core/instance/init.js</div>
<ol class="arabic">
<li>
<p>合并构造函数的参数到vm.$options中</p>
</li>
<li>
<p>init events &amp; lifecycle &amp; render</p>
</li>
<li>
<p>beforeCreate</p>
</li>
<li>
<p>init injections &amp; state &amp; provide</p>
</li>
<li>
<p>created</p>
</li>
<li>
<p>将el转化为template, 再将template转化为render函数</p>
</li>
<li>
<p>beforeMount</p>
</li>
<li>
<p>$mount</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>new Watcher()</p>
</li>
<li>
<p>vm.render(): 调用 <code>vm.$createElement</code> 将html转成VNode</p>
</li>
<li>
<p>将解析后的VNode append到el的parent的children下</p>
</li>
<li>
<p>将旧的el删除</p>
</li>
</ol>
</div>
</li>
<li>
<p>mounted</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vue-patch"><a class="link" href="#vue-patch">3. patch</a></h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="olist arabic">
<div class="title">判断两个VNode是否相同:</div>
<ol class="arabic">
<li>
<p>key相同.</p>
</li>
<li>
<p>如果是文本节点, 则文本内容相同.</p>
</li>
<li>
<p>如果是input标签, 则type相同.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_patchvnode"><a class="link" href="#_patchvnode">3.1. patchVNode</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>updateAttrs</p>
</li>
<li>
<p>updateClass</p>
</li>
<li>
<p>updateDOMListeners</p>
</li>
<li>
<p>updateDOMProps</p>
</li>
<li>
<p>updateStyle</p>
</li>
<li>
<p>update</p>
</li>
<li>
<p>updateDirectives</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_updatechildren"><a class="link" href="#_updatechildren">3.2. updateChildren</a></h3>
<div class="listingblock">
<div class="title">src/core/vdom/patch.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">function updateChildren (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
    let oldStartIdx = 0;
    let newStartIdx = 0;
    let oldEndIdx = oldCh.length - 1;
    let oldStartVnode = oldCh[0];
    let oldEndVnode = oldCh[oldEndIdx];
    let newEndIdx = newCh.length - 1;
    let newStartVnode = newCh[0];
    let newEndVnode = newCh[newEndIdx]; <i class="conum" data-value="1"></i><b>(1)</b>
    let oldKeyToIdx, idxInOld, vnodeToMove, refElm;
    const canMove = !removeOnly;
    while (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
      if (isUndef(oldStartVnode)) {
        oldStartVnode = oldCh[++oldStartIdx] // Vnode has been moved left
      } else if (isUndef(oldEndVnode)) {
        oldEndVnode = oldCh[--oldEndIdx]
      } else if (sameVnode(oldStartVnode, newStartVnode)) { <i class="conum" data-value="2"></i><b>(2)</b>
        patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);
        oldStartVnode = oldCh[++oldStartIdx];
        newStartVnode = newCh[++newStartIdx]
      } else if (sameVnode(oldEndVnode, newEndVnode)) { <i class="conum" data-value="3"></i><b>(3)</b>
        patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);
        oldEndVnode = oldCh[--oldEndIdx];
        newEndVnode = newCh[--newEndIdx]
      } else if (sameVnode(oldStartVnode, newEndVnode)) { <i class="conum" data-value="4"></i><b>(4)</b>
        patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);
        canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm));
        oldStartVnode = oldCh[++oldStartIdx];
        newEndVnode = newCh[--newEndIdx]
      } else if (sameVnode(oldEndVnode, newStartVnode)) { <i class="conum" data-value="5"></i><b>(5)</b>
        patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);
        canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm);
        oldEndVnode = oldCh[--oldEndIdx];
        newStartVnode = newCh[++newStartIdx]
      } else {
        if (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx);
        idxInOld = isDef(newStartVnode.key)
          ? oldKeyToIdx[newStartVnode.key]
          : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx); <i class="conum" data-value="6"></i><b>(6)</b>
        if (isUndef(idxInOld)) { <i class="conum" data-value="7"></i><b>(7)</b>
          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
        } else {
          vnodeToMove = oldCh[idxInOld];
          if (sameVnode(vnodeToMove, newStartVnode)) { <i class="conum" data-value="8"></i><b>(8)</b>
            patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);
            oldCh[idxInOld] = undefined;
            canMove &amp;&amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)
          } else { <i class="conum" data-value="9"></i><b>(9)</b>
            createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
          }
        }
        newStartVnode = newCh[++newStartIdx]
      }
    }
    if (oldStartIdx &gt; oldEndIdx) {
      refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm;
      addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue) <i class="conum" data-value="10"></i><b>(10)</b>
    } else if (newStartIdx &gt; newEndIdx) {
      removeVnodes(oldCh, oldStartIdx, oldEndIdx) <i class="conum" data-value="11"></i><b>(11)</b>
    }
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>初始化新旧children首尾index以及VNode</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>旧首和新首相同, 则patch下旧首.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>旧尾和新尾相同, 则patch下旧尾.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>旧首和新尾相同, 则patch下旧首, 并将旧首移动到旧尾的后面.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>旧尾和新首相同, 则patch下旧尾, 并将旧尾移动到旧首的前面.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>如果新旧首尾都不同, 则在oldChildren中根据新首的key寻找相同的VNode.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>如果找不到, 则将新首插入到旧首前.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>如果找到, 并且是同类VNode, 则patch该VNode, 并将patch后的VNode插入到旧首的前面. 原旧节点位置元素置为undefined.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>如果找到, 但不是同类VNode, 则相当于没找到, 同步骤7.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>如果oldChildren先遍历完, 则说明newChildren中有新VNode加入, 则将newChildren中从 <code>newStartIdx</code> 到 <code>newEndIdx</code> 的VNode插入到旧尾.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>如果newChildren先遍历完, 则说明newChildren中有VNode被删除, 则将oldChildren中从 <code>newStartIdx</code> 到 <code>newEndIdx</code> 的VNode删除.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vue-debug-env"><a class="link" href="#vue-debug-env">4. 调试环境搭建</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_下载代码"><a class="link" href="#_下载代码">4.1. 下载代码</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">git clone git@github.com:vuejs/vue.git
cd vue

export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
yarn config set sass_binary_site https://npm.taobao.org/mirrors/node-sass
yarn config set phantomjs_cdnurl https://npm.taobao.org/mirrors/phantomjs
yarn</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_修改配置"><a class="link" href="#_修改配置">4.2. 修改配置</a></h3>
<div class="paragraph">
<p><code>package.json</code> 里 <code>dev</code> 后加上 <code>--sourcemap</code> .</p>
</div>
</div>
<div class="sect2">
<h3 id="_打包vue"><a class="link" href="#_打包vue">4.3. 打包vue</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">yarn dev</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_测试页面"><a class="link" href="#_测试页面">4.4. 测试页面</a></h3>
<div class="listingblock">
<div class="title">examples/HelloWorld.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Hello World&lt;/title&gt;
  &lt;script src="../dist/vue.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="demo"&gt;
  {{message}}
&lt;/div&gt;
&lt;script&gt;
  new Vue({
    el: '#demo',
    data() {
      return{
        message: "Hello World!"
      }
    }
  })
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>debug这个页面即可.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-10-12 20:07:21 +0800
</div>
</div>
<link rel="stylesheet" href="js/highlight/styles/idea.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<style>

    .hljs-comment, .quoteblock blockquote, .quoteblock blockquote p {
        font-style: normal;
    }

    .listingblock:hover .clipboard {
        display: block;
    }

    .clipboard {
        display: none;
        border: 0;
        font-size: .7em;
        text-transform: uppercase;
        font-weight: 400;
        padding: 6px;
        color: #999;
        position: absolute;
        cursor: pointer;
        top: .425rem;
        right: .1rem;
        background: transparent;
    }

    code + .clipboard {
        top: 2rem !important;
    }

    .clipboard:hover, .clipboard:focus, .clipboard:active {
        outline: 0;
        background-color: #eee9e6;
    }
</style>

<script src="js/tocbot/tocbot.min.js" type="text/javascript"></script>
<script src="js/toc.js" type="text/javascript"></script>
<script src="https://cdn.bootcss.com/clipboard.js/2.0.4/clipboard.min.js"></script>
<script src="js/clipboardInit.js" type="text/javascript"></script>
</body>
</html>